# subscribe-me

[![Generated with nod](https://img.shields.io/badge/generator-nod-2196F3.svg?style=flat-square)](https://github.com/diegohaz/nod)
[![NPM version](https://img.shields.io/npm/v/subscribe-me.svg?style=flat-square)](https://npmjs.org/package/subscribe-me)
[![Build Status](https://img.shields.io/travis/yaplas/subscribe-me/master.svg?style=flat-square)](https://travis-ci.org/yaplas/subscribe-me) [![Coverage Status](https://img.shields.io/codecov/c/github/yaplas/subscribe-me/master.svg?style=flat-square)](https://codecov.io/gh/yaplas/subscribe-me/branch/master)

Events subscriptions CRUD and dispatcher. In an event driven microservices architecture it helps to keep generic events but specific subscriptions.

## Install

npm:

    npm i subscribe-me

Yarn:

    yarn add subscribe-me

## Usage

```js
import {createMemoryStorage, createSubscriber, createNotifier} from "subscribe-me";
import { from } from "rxjs";

// memory storage is for testing/experiments purpose
const storage = createMemoryStorage();
const subscriber = createSubscriber({storage});

// you can subscribe to an event
const id = subscriber.subscribe({
    event: "value-change",
    target: "my-api.com/my-endpoint",
    // you can specify a criteria for the event payload
    // it supports mongodb where clause style
    criteria: { previous: { $gte: 50 }, current: { $lt: 50 } }
});

const notifier = createNotifier({storage});

// getNotification method accept a rxjs stream of events and return a rxjs stream of notifications
const notifications = notifier.getNotifications(
    from([
        // given the subscription criteria this event should be ignored
        {type: "value-change", payload: { previous: 60, current: 54 } },
        // this event should trigger a notification
        {type: "value-change", payload: { previous: 54, current: 49 } },
    ])
);

// dispatch notification to console log
// this subscribe is the rxjs Observable subscribe method
notifications.subscribe(console.log);

// you can unsubscribe from the event using the subscription id
subscriber.unsubscribe(id);
```

### PostgreSQL Storage

It is possible to provide your PostgreSQL db configuration or calling the function with no arguments you let postgres client get the configuration from evironment variables, click [here](https://node-postgres.com/features/connecting) for details.

```js
import { createPostgresStorage } from "subscribe-me";

// you can use directly createPostgresStorage() with no argumwents
// to get postgres config from environment variables
const storage = createPostgresStorage({
    user: 'dbuser',
    host: 'database.server.com',
    database: 'mydb',
    password: 'secretpassword',
    port: 3211,
})

```

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

### createSubscriber

It returns an object with the `subscribe` and `unsubscribe` methods.

```js

const subscriber = createSubscriber({storage});

// the target could be any thing that make sense for yoy (url, email, stringified json...)
const id = subscriber.add({event: "the-event", target: "my-target", criteria: { value: { $gte: 20 }});

// the unsubscribe method require the id that was the result of the subscription
subscriber.remove(id);

```

### createNotifier

It return an object with the `getNotification` method which accepts an Observable of income events, and return an Observable of outcome notifications.


```js

const notifier = createNotifier({storage});

// event must contain a string type field and a payload
// payload is optional but if it is present it should be a json object
// no strings, numbers, dates, arrays... are allowed for payload
// { type: "the-event", payload: { value: 22 } }
const notifications = notifier.getNotifications(events)

```


## License

MIT Â© [Agustin Lascialandare](https://github.com/yaplas)
