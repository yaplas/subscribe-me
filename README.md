# subscribe-me

[![Generated with nod](https://img.shields.io/badge/generator-nod-2196F3.svg?style=flat-square)](https://github.com/diegohaz/nod)
[![NPM version](https://img.shields.io/npm/v/subscribe-me.svg?style=flat-square)](https://npmjs.org/package/subscribe-me)
[![Build Status](https://img.shields.io/travis/yaplas/subscribe-me/master.svg?style=flat-square)](https://travis-ci.org/yaplas/subscribe-me) [![Coverage Status](https://img.shields.io/codecov/c/github/yaplas/subscribe-me/master.svg?style=flat-square)](https://codecov.io/gh/yaplas/subscribe-me/branch/master)

Events subscriptions CRUD and dispatcher. In an event driven microservices architecture it helps to keep generic events but specific subscriptions.

## Install

npm:

    npm i subscribe-me

Yarn:

    yarn add subscribe-me

## Usage

```js
import {createMemoryStorage, createSubscriber, createNotifier} from "subscribe-me";
import { from } from "rxjs";

// memory storage is for testing/experiments purpose
const storage = createMemoryStorage();
const subscriber = createSubscriber({storage});

// you can subscribe to an event
const id = subscriber.subscribe({
    event: "value-change",
    target: "my-api.com/my-endpoint",
    // you can specify a criteria for the event payload
    // it supports mongodb where clause style
    criteria: { previous: { $gte: 50 }, current: { $lt: 50 } }
});

// you can use bufferMilliseconds to setup an event time buffer
// this is to reduce the amount of subscriptions storage queries
// it works grouping the events by event type and performing only one query per event type
const notifier = createNotifier({
    storage,
    bufferMilliseconds: 10000,
});

// getNotification method accept a rxjs stream of events and return a rxjs stream of notifications
const notifications = notifier.getNotifications(
    from([
        // given the subscription criteria this event should be ignored
        {type: "value-change", payload: { previous: 60, current: 54 } },
        // this event should trigger a notification
        {type: "value-change", payload: { previous: 54, current: 49 } },
    ])
);

// dispatch notification to console log
// this subscribe is the rxjs Observable subscribe method
notifications.subscribe(console.log);

// you can unsubscribe from the event using the subscription id
subscriber.unsubscribe(id);
```

### PostgreSQL Storage

It is possible to create a postgres storage providing the postgres connection configuration. Besides postgres specific confuguration setting you can provide the subscription table name and the cbhunk size. The database is accesed via a cursor that get the data by chunks, if the chunk size is 1000 then each chunk will contain 1000 table rows.

```js
import { createPostgresStorage } from "subscribe-me";

const storage = createPostgresStorage({
    user: "dbuser",
    host: "database.server.com",
    database: "mydb",
    password: "secretpassword",
    port: 3211,
    // besides the postgres settings you can optionally
    // porvide the table name and the chunk size
    // the following values are the defaults
    table: "event_subscriptions",
    chunkSize: 1000,
})
```

Also you can provide directly the connection pool, so for instance, you can allow postgres get its configuration from environment variables.

```js
import { createPostgresStorage } from "subscribe-me";
import { Pool } from "pg";

const storage = createPostgresStorage({
    pool: new Pool(),
    table: "event_subscriptions",
    chunkSize: 1000,
})
```

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [createMemoryStorage](#creatememorystorage)
-   [createPostgresStorage](#createpostgresstorage)
    -   [Parameters](#parameters)
-   [createSubscriber](#createsubscriber)
    -   [Parameters](#parameters-1)
-   [createNotifier](#createnotifier)
    -   [Parameters](#parameters-2)

### createMemoryStorage

Creates a memory storage, it is used just for tesnting and experiments.

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** the storage to be used to create a notifier or a subscriber.

### createPostgresStorage

Creates PostgreSQL storage.

#### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Postgres configuration
    -   `options.user` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** db user
    -   `options.password` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** db user password
    -   `options.host` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** db host
    -   `options.port` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** db host
    -   `options.database` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** db name
    -   `options.chunkSize` **[number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)** the chunk size (optional, default `1000`)
    -   `options.table` **[string](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** subscription table name (optional, default `"event_subscriptions"`)

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** The storage to be used to create a notifier or a subscriber.

### createSubscriber

Create the suubscriber.

#### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** configuration options
    -   `options.storage` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** storage object (e.g. memory storage)

Returns **any** The subscriber with the `subscribe` and `unsubscribe` methods.

### createNotifier

Creates the notifier.

#### Parameters

-   `options` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** configuration options
    -   `options.storage` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** storage object (e.g. memory storage)

Returns **any** The notifier with the `getNotification` method, it receive the input event stream and return the notification event stream (rxjs observable)

## License

MIT Â© [Agustin Lascialandare](https://github.com/yaplas)
